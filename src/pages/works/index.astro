---
import Layout from '../../layouts/Layout.astro';
import { getProjects, getWorksPage, urlFor } from '../../lib/sanity';

const projects = await getProjects();
const worksData = await getWorksPage();

// SEO
const metaTitle = worksData?.metaTitle || 'Works | aspectmobili by HITOBA DESIGN';
const metaDescription = worksData?.metaDescription || '';

// Hero
const heroTitle = worksData?.heroTitle || 'Works';
const filterAllLabel = worksData?.filterAllLabel || 'All Projects';

// Extract unique categories for filter
const allCategories = projects.flatMap(p => p.categories || []);
const uniqueCategories = [...new Set(allCategories)];

// Sort projects by year (latest first)
const sortedProjects = [...projects].sort((a, b) => (b.completionYear || 0) - (a.completionYear || 0));
---

<Layout title={metaTitle} description={metaDescription} bodyClass="works-page">
    <section class="works-hero">
        <div class="works-hero-inner">
            <h1 class="works-hero-title reveal-hero">{heroTitle}</h1>
            <div class="works-filter reveal-hero">
                <button class="works-filter-btn" id="works-filter-btn">
                    <svg width="12" height="8" viewBox="0 0 12 8" fill="none">
                        <path d="M1 1.5L6 6.5L11 1.5" stroke="currentColor" stroke-width="1.5"
                            stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                    <span>Filter</span>
                </button>
                <div class="works-filter-dropdown" id="works-filter-dropdown">
                    <button class="filter-option active" data-filter="all">{filterAllLabel}</button>
                    {uniqueCategories.map((cat) => (
                        <button class="filter-option" data-filter={cat.toLowerCase().replace(/\s+/g, '-')}>{cat}</button>
                    ))}
                </div>
            </div>
        </div>
    </section>

    <!-- Projects Grid -->
    <section class="works-grid-section">
        <div class="works-container">
            <div class="works-projects-grid">
                {sortedProjects.map((project) => (
                    <article 
                        class="works-project-card" 
                        data-categories={(project.categories || []).map((c: string) => c.toLowerCase().replace(/\s+/g, '-')).join(' ')}
                    >
                        <a href={`/works/${project.slug?.current || ''}`} class="works-card-link">
                            <div class="works-card-image-wrap">
                                <img 
                                    src={project.mainImage ? urlFor(project.mainImage).width(1200).url() : '/placeholder.png'} 
                                    alt={project.title} 
                                    loading="lazy" 
                                />
                            </div>
                            <div class="works-card-info">
                                <h3 class="works-card-title">{project.title}</h3>
                                <div class="works-card-meta">
                                    <div class="works-meta-details">
                                        <div class="works-meta-row">
                                            <span class="works-meta-label">Area</span>
                                            <span class="works-meta-value">{project.area}</span>
                                        </div>
                                        <div class="works-meta-row">
                                            <span class="works-meta-label">Completion</span>
                                            <span class="works-meta-value">{project.completionYear}</span>
                                        </div>
                                    </div>
                                    <div class="works-card-tags">
                                        {project.categories?.map((cat: string) => (
                                            <span>{cat}</span>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </a>
                    </article>
                ))}

                {sortedProjects.length === 0 && (
                    <p style="grid-column: 1/-1; text-align: center; padding: 100px 0; opacity: 0.7;">
                        No projects found. Add some in Sanity Studio!
                    </p>
                )}
            </div>
        </div>
    </section>

</Layout>
