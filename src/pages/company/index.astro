---
import Layout from '../../layouts/Layout.astro';
import { PortableText } from 'astro-portabletext';
import { getCompanyPage, getSiteSettings } from '../../lib/sanity';

const companyData = await getCompanyPage();
const settings = await getSiteSettings();

// SEO
const metaTitle = companyData?.metaTitle || 'Company | aspectmobili by HITOBA DESIGN';
const metaDescription = companyData?.metaDescription || settings?.description || '';

// Fallbacks
const hero = companyData?.hero || {
  mainTitle: 'Company',
  logoText: 'ASPECTMOBILI',
  description: ''
};

const statement = companyData?.statement || {
  number: '(01)',
  text: ''
};

const numbers = companyData?.numbers || [];
const profileRows = companyData?.profileRows || [];
const profileSectionTitle = companyData?.profileSectionTitle || 'Company Profile';

const manifesto = companyData?.manifesto || {
    title: '',
    columns: []
};

const historySectionTitle = companyData?.historySectionTitle || 'History';
const history = companyData?.history || [];

const clientsSectionTitle = companyData?.clientsSectionTitle || 'Clients';
const clients = companyData?.clients || [];

const access = companyData?.access || {
    title: 'Access',
    googleMapsUrl: '',
    details: []
};

const contactPortal = settings?.contactPortal || {
  tag: 'GET IN TOUCH',
  title: 'Start your<br>project',
  btnText: 'CONTACT US',
  link: '/contact/'
};

// Google Maps URL fallback
const mapsUrl = access.googleMapsUrl || settings?.googleMapsUrl || 'https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3240.5!2d139.7075!3d35.6815!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x0%3A0x0!2zMzXCsDQwJzUzLjQiTiAxMznCsDQyJzI3LjAiRQ!5e0!3m2!1sja!2sjp!4v1700000000000';
---

<Layout title={metaTitle} description={metaDescription} bodyClass="company-page">
    <section class="co-hero" id="co-hero">
        <div class="co-hero-top-left">
            <h1 class="co-page-title reveal-hero">{hero.mainTitle}</h1>
        </div>

        <div class="co-hero-center">
            <div class="co-hero-logo reveal-hero">
                <span>{hero.logoText}</span>
            </div>
        </div>

        <div class="co-hero-bottom-right">
            <div class="co-hero-desc reveal-hero">
                <p set:html={hero.description}></p>
            </div>
        </div>

        <div class="scroll-hint reveal-hero">
            <span>Scroll</span>
            <div class="hint-line"></div>
        </div>
    </section>

    <!-- 02. STATEMENT -->
    {statement.text && (
        <section class="co-statement section-padding">
            <div class="container">
                <div class="co-statement-inner">
                    <span class="co-section-num co-reveal">{statement.number}</span>
                    <div class="co-statement-text co-reveal"><PortableText value={statement.text} /></div>
                </div>
            </div>
        </section>
    )}

    <!-- 03. NUMBERS -->
    {numbers.length > 0 && (
        <section class="co-numbers">
            <div class="container">
                <div class="co-numbers-grid">
                    {numbers.map((item) => (
                        <div class="co-number-item co-reveal">
                            <span class="co-number-value" data-target={item.value}>0</span>
                            <span class="co-number-suffix">{item.suffix}</span>
                            <p class="co-number-label">{item.label}</p>
                        </div>
                    ))}
                </div>
            </div>
        </section>
    )}

    <!-- 04. COMPANY PROFILE TABLE -->
    {profileRows.length > 0 && (
        <section class="co-profile section-padding">
            <div class="container">
                <div class="co-profile-header">
                    <span class="co-section-num co-reveal">(02)</span>
                    <h2 class="co-profile-title co-reveal">{profileSectionTitle}</h2>
                </div>
                <div class="co-profile-table co-reveal">
                    {profileRows.map((row) => (
                        <div class="co-profile-row">
                            <span class="co-profile-key">{row.key}</span>
                            <span class="co-profile-val" set:html={row.value}></span>
                        </div>
                    ))}
                </div>
            </div>
        </section>
    )}

    <!-- 05. MANIFESTO -->
    {manifesto.columns && manifesto.columns.length > 0 && (
        <section class="co-manifesto section-padding">
            <div class="container">
                <div class="co-manifesto-grid">
                    <div class="co-manifesto-main co-reveal">
                        <h2 class="co-manifesto-title" set:html={manifesto.title}></h2>
                    </div>
                    <div class="co-manifesto-cols">
                        {manifesto.columns.map((col: any) => (
                            <div class="co-manifesto-col co-reveal">
                                <span class="co-manifesto-num">{col.num}</span>
                                <h3>{col.title}</h3>
                                <PortableText value={col.text} />
                            </div>
                        ))}
                    </div>
                </div>
            </div>
        </section>
    )}

    <!-- 06. TIMELINE -->
    {history.length > 0 && (
        <section class="co-timeline section-padding">
            <div class="container">
                <div class="co-timeline-header">
                    <span class="co-section-num co-reveal">(04)</span>
                    <h2 class="co-timeline-title co-reveal">{historySectionTitle}</h2>
                </div>
                <div class="co-tl-list">
                    {history.map((entry) => (
                        <div class="co-tl-entry co-reveal">
                            <div class="co-tl-year-big">{entry.year}</div>
                            <div class="co-tl-sep"></div>
                            <div class="co-tl-body">
                                <h3>{entry.title}</h3>
                                <PortableText value={entry.text} />
                            </div>
                        </div>
                    ))}
                </div>
            </div>
        </section>
    )}

    <!-- 07. CLIENTS -->
    {clients.length > 0 && (
        <section class="co-clients section-padding">
            <div class="container">
                <div class="co-clients-header">
                    <span class="co-section-num co-reveal">(05)</span>
                    <h2 class="co-clients-title co-reveal">{clientsSectionTitle}</h2>
                </div>
                <div class="co-clients-grid">
                    {clients.map((client) => (
                        <div class="co-client-item co-reveal">
                            <span class="co-client-name">{client.name}</span>
                            <span class="co-client-type">{client.type}</span>
                        </div>
                    ))}
                </div>
            </div>
        </section>
    )}

    <!-- 08. MAP / LOCATION -->
    <section class="co-location section-padding">
        <div class="container">
            <div class="co-location-header">
                <span class="co-section-num co-reveal">(06)</span>
                <h2 class="co-location-title co-reveal">{access.title}</h2>
            </div>
            <div class="co-location-content co-reveal">
                <div class="co-map-wrap">
                    <iframe
                        src={mapsUrl}
                        width="100%" height="100%" style="border:0;" allowfullscreen="" loading="lazy"
                        referrerpolicy="no-referrer-when-downgrade"></iframe>
                </div>
                <div class="co-location-details">
                    {access.details?.map((detail) => (
                        <div class="co-loc-item">
                            <span class="co-loc-label">{detail.label}</span>
                            <p>{detail.text}</p>
                        </div>
                    ))}
                </div>
            </div>
        </div>
    </section>

    <section class="contact-portal" id="contact-portal">
        <div class="portal-container">
            <a href={contactPortal.link || '/contact/'} class="portal-link">
                <div class="portal-content">
                    <span class="portal-tag">{contactPortal.tag}</span>
                    <h2 class="portal-title" set:html={contactPortal.title}></h2>
                    <div class="portal-magnetic-btn">
                        <span class="btn-circle"></span>
                        <span class="btn-text">{contactPortal.btnText}</span>
                    </div>
                </div>
            </a>
        </div>
    </section>
</Layout>
