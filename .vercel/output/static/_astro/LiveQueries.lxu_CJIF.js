import{eI as j,a1 as N,a2 as O,a0 as L,eJ as D,eK as U,eL as V,eM as J,G as P,ed as B}from"./index.GAdVpEDN.js";import{c as R}from"./compiler-runtime.BVN8GnAY.js";import{c as H}from"./index.DN6yRWMu.js";import{i as T}from"./DisplayedDocumentBroadcaster.DjlGGhGj.js";import{r as m}from"./index.DB4Po_jQ.js";import{y as K,z,o as G,b0 as Y,b1 as F,b2 as W,b3 as C,b4 as X,Q as Z,b5 as ee}from"./studio-component.CBxzOH7u.js";import"./client.C73kiKoU.js";function te(t){if(Array.isArray(t)&&t.length>1&&t.includes("raw"))throw new TypeError('Invalid API perspective value: "raw". The raw-perspective can not be combined with other perspectives')}function re(t){if(te(t),Array.isArray(t))return t.includes("published")?t:[...t,"published"];switch(t){case"previewDrafts":case"drafts":return["drafts","published"];case"published":default:return["published"]}}function se(t,e){const s=re(e);function a(r){for(const n of s){let i=null;if(n.startsWith("r")&&(i=t({...r,_id:N(r._id,n)})),n==="drafts"&&(i=t({...r,_id:O(r._id)})),n==="published"&&(i=t({...r,_id:L(r._id)})),i)return{...i,_id:L(i._id),_originalId:i._id}}return null}return function(r){return a(r)}}function ne(t,e,s,a,r){if(!e)return t;const n=se(s,r),i=e.documents?.map?.(n)||[];return j(JSON.parse(JSON.stringify(t)),(l,d)=>{const h=D(d,e);if(!h)return l;const{mapping:u,pathSuffix:f}=h;if(u.type!=="value"||u.source.type!=="documentValue")return l;const p=e.documents[u.source.document],E=e.paths[u.source.path];if(p){const v=U(E+f),w=V(v),y=i[u.source.document];if(!y)return l;const g=y?J(y,w,l):l;return l===g?l:a(g,{cachedDocument:y,previousValue:l,sourceDocument:p,sourcePath:v})}return l})}function ie(t,e){switch(e.type){case"message":return{...t,messages:[...t.messages,e]};case"reconnect":case"restart":return{...t,messages:[],resets:t.resets+1};case"welcome":return t;default:throw Error(`Unknown event: ${e.type}`,{cause:e})}}const ae={messages:[],resets:0};function oe(t){const e=R.c(3),[s,a]=m.useReducer(ie,ae),[r,n]=m.useState(null);if(r!==null)throw r;let i,l;return e[0]!==t.live?(i=()=>{const d=t.live.events({includeDrafts:!0,tag:"presentation-loader"}).subscribe({next:a,error:h=>n(h instanceof Error?h:new Error("Unexpected error in useLiveEvents",{cause:h}))});return()=>d.unsubscribe()},l=[t.live],e[0]=t.live,e[1]=i,e[2]=l):(i=e[1],l=e[2]),m.useEffect(i,l),m.useDeferredValue(s)}const ue=(t,{previousValue:e})=>{if(typeof e=="string"){if(typeof t=="number")return`${t}`;if(Array.isArray(t)){if(t.length===0)return"";if(t.some(s=>typeof s=="object"&&Y(s)))return F(t)}}return t};function ce(t,e,s){return`${t}:${e}:${JSON.stringify(s)}`}function le(t){if(t.queries.size<1)return t;const e=Date.now();if(!Array.from(t.heartbeats.values()).some(r=>r.heartbeat!==!1&&e>r.receivedAt+r.heartbeat))return t;const s=new Map,a=new Map;for(const[r,n]of t.heartbeats.entries())n.heartbeat!==!1&&e>n.receivedAt+n.heartbeat||(s.set(r,n),a.set(r,t.queries.get(r)));return{...t,queries:a,heartbeats:s}}function pe(t,{payload:e}){const s=ce(e.perspective,e.query,e.params),a={query:e.query,params:e.params,perspective:e.perspective},r=new Map(t.heartbeats);r.set(s,{receivedAt:Date.now(),heartbeat:e.heartbeat});let n=t.queries;return(!t.queries.has(s)||!T(t.queries.get(s),a))&&(n=new Map(t.queries),n.set(s,a)),{heartbeats:r,queries:n}}function fe(t,e){switch(e.type){case"query-listen":return pe(t,e);case"gc":return le(t);default:throw Error(`Unknown action: ${e.type}`,{cause:e})}}const de={queries:new Map,heartbeats:new Map};function me(){const t=R.c(4),[e,s]=m.useReducer(fe,de);let a,r;t[0]===Symbol.for("react.memo_cache_sentinel")?(a=()=>{const l=setInterval(()=>s({type:"gc"}),W);return()=>clearInterval(l)},r=[],t[0]=a,t[1]=r):(a=t[0],r=t[1]),m.useEffect(a,r);const n=m.useDeferredValue(e.queries);let i;return t[2]!==n?(i=[n,s],t[2]=n,t[3]=i):i=t[3],i}function Me(t){const e=R.c(28),{controller:s,perspective:a,onLoadersConnection:r,onDocumentsOnPage:n}=t,[i,l]=m.useState(),[d,h]=me(),u=K(),f=z();let p,E;e[0]!==s||e[1]!==f||e[2]!==h||e[3]!==n||e[4]!==r||e[5]!==u?(p=()=>{if(s){const c=s.createChannel({name:"presentation",connectTo:"loaders",heartbeat:!0},B().provide({actors:H()}));return l(c),c.onStatus(r),c.on("loader/documents",o=>{o.projectId===u&&o.dataset===f&&n("loaders",o.perspective,o.documents)}),c.on("loader/query-listen",o=>{if(o.projectId===u&&o.dataset===f){if(typeof o.heartbeat=="number"&&o.heartbeat<C)throw new Error(`Loader query listen heartbeat interval must be at least ${C}ms`);h({type:"query-listen",payload:{perspective:o.perspective,query:o.query,params:o.params,heartbeat:o.heartbeat??!1}})}}),c.start()}return he},E=[s,f,h,n,r,u],e[0]=s,e[1]=f,e[2]=h,e[3]=n,e[4]=r,e[5]=u,e[6]=p,e[7]=E):(p=e[6],E=e[7]),m.useEffect(p,E);let v;e[8]!==a?(v=ee(a)?X:{apiVersion:Z},e[8]=a,e[9]=v):v=e[9];const w=G(v);let y;e[10]!==w?(y=w.withConfig({resultSourceMap:"withKeyArraySelector"}),e[10]=w,e[11]=y):y=e[11];const g=y;let q,A;e[12]!==a||e[13]!==i||e[14]!==f||e[15]!==u?(q=()=>{i&&i.post("loader/perspective",{projectId:u,dataset:f,perspective:a})},A=[i,a,u,f],e[12]=a,e[13]=i,e[14]=f,e[15]=u,e[16]=q,e[17]=A):(q=e[16],A=e[17]),m.useEffect(q,A);const I=m.useDeferredValue(t.liveDocument),_=oe(g);let S;e[18]!==d?(S=[...d.entries()],e[18]=d,e[19]=S):S=e[19];let b;return e[20]!==g||e[21]!==i||e[22]!==f||e[23]!==I||e[24]!==_||e[25]!==u||e[26]!==S?(b=P.jsx(P.Fragment,{children:S.map(c=>{const[o,M]=c,{query:x,params:$,perspective:k}=M;return P.jsx(Q,{projectId:u,dataset:f,perspective:k,query:x,params:$,comlink:i,client:g,liveDocument:I,liveEventsMessages:_.messages},`${_.resets}:${o}`)})}),e[20]=g,e[21]=i,e[22]=f,e[23]=I,e[24]=_,e[25]=u,e[26]=S,e[27]=b):b=e[27],b}function he(){}function ye(t){const e=R.c(20),{projectId:s,dataset:a,perspective:r,query:n,client:i,liveDocument:l,params:d,comlink:h,liveEventsMessages:u}=t,{result:f,resultSourceMap:p,syncTags:E}=be({client:i,liveDocument:l,params:d,perspective:r,query:n,liveEventsMessages:u})||{};let v;e[0]!==a||e[1]!==s?(v=(q,A,I,_,S,b,c)=>{q?.post("loader/query-change",{projectId:s,dataset:a,perspective:A,query:I,params:_,result:S,resultSourceMap:b,tags:c})},e[0]=a,e[1]=s,e[2]=v):v=e[2];const w=m.useEffectEvent(v);let y;e[3]!==h||e[4]!==w||e[5]!==d||e[6]!==r||e[7]!==n||e[8]!==f||e[9]!==p||e[10]!==E?(y=()=>{p&&w(h,r,n,d,f,p,E)},e[3]=h,e[4]=w,e[5]=d,e[6]=r,e[7]=n,e[8]=f,e[9]=p,e[10]=E,e[11]=y):y=e[11];let g;return e[12]!==h||e[13]!==d||e[14]!==r||e[15]!==n||e[16]!==f||e[17]!==p||e[18]!==E?(g=[h,d,r,n,f,p,E],e[12]=h,e[13]=d,e[14]=r,e[15]=n,e[16]=f,e[17]=p,e[18]=E,e[19]=g):g=e[19],m.useEffect(y,g),null}const Q=m.memo(ye);Q.displayName="Memo(QuerySubscription)";function be(t){const e=R.c(30),{liveDocument:s,client:a,query:r,params:n,perspective:i,liveEventsMessages:l}=t,[d,h]=m.useState(null),[u,f]=m.useState(null),[p,E]=m.useState(void 0);let v;e[0]!==l?(v=()=>new Set(l.map(ve)),e[0]=l,e[1]=v):v=e[1];const[w]=m.useState(v);let y;if(e[2]!==l||e[3]!==w||e[4]!==p){let b;e[6]!==w?(b=M=>!w.has(M.id),e[6]=w,e[7]=b):b=e[7];const c=l.filter(b);let o;e[8]!==p?(o=M=>M.tags.some(x=>p?.includes(x)),e[8]=p,e[9]=o):o=e[9],y=c.findLast(o),e[2]=l,e[3]=w,e[4]=p,e[5]=y}else y=e[5];const g=y?.id,[q,A]=m.useState(null);if(q)throw q;let I,_;e[10]!==a||e[11]!==g||e[12]!==n||e[13]!==i||e[14]!==r?(I=()=>{const b=new AbortController;return a.fetch(r,n,{lastLiveEventId:g,tag:"presentation-loader",signal:b.signal,perspective:i,filterResponse:!1,returnQuery:!1}).then(c=>{m.startTransition(()=>{h(o=>T(o,c.result)?o:c.result),f(o=>T(o,c.resultSourceMap)?o:c.resultSourceMap),E(o=>T(o,c.syncTags)?o:c.syncTags)})}).catch(c=>{(typeof c!="object"||c?.name!=="AbortError")&&A(c)}),()=>{b.abort()}},_=[a,g,n,i,r],e[10]=a,e[11]=g,e[12]=n,e[13]=i,e[14]=r,e[15]=I,e[16]=_):(I=e[15],_=e[16]),m.useEffect(I,_);let S;e:{if(s&&u){let c;e[17]!==s||e[18]!==i||e[19]!==d||e[20]!==u?(c=ge(s,d,i,u),e[17]=s,e[18]=i,e[19]=d,e[20]=u,e[21]=c):c=e[21];let o;e[22]!==u||e[23]!==p||e[24]!==c?(o={result:c,resultSourceMap:u,syncTags:p},e[22]=u,e[23]=p,e[24]=c,e[25]=o):o=e[25],S=o;break e}let b;e[26]!==d||e[27]!==u||e[28]!==p?(b={result:d,resultSourceMap:u,syncTags:p},e[26]=d,e[27]=u,e[28]=p,e[29]=b):b=e[29],S=b}return S}function ve(t){return t.id}function ge(t,e,s,a){if(s==="raw")throw new Error("turboChargeResultIfSourceMap does not support raw perspective");return ne(e,a,r=>!r._projectId&&t?._id&&L(t._id)===L(r._id)?typeof t._id=="string"&&typeof r._type=="string"?t:{...t,_id:t._id||r._id,_type:t._type||r._type}:null,ue,Array.isArray(s)?s.filter(Boolean):s)}export{Me as default,ge as turboChargeResultIfSourceMap};
